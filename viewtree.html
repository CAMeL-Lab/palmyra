<!DOCTYPE html>
<!--
Palmyra
Copyright (c) 2019 New York University Abu Dhabi

License: MIT BSD-3

THIS SOFTWARE IS PROVIDED ''AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING,
BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
IN NO EVENT SHALL THE U.S. GOVERNMENT OR ANY DEPARTMENTS OR EMPLOYEES THEREOF BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,
EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.)
-->
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="main.css">
    <title>Palmyra v2.4</title>
</head>

<body class="viewtree">

    <div class="navbar">
        <div class="container">
            <a href="index.html"><img src="fonts/logo.png" alt="palmyra" id='logo' /></a>
            <div class="toolbar btn-initial" align="left">
                <input type="button" tabindex="-1" value="clear" onClick="clearTree()" />
            </div>
            <div id="conlluFileNameDiv">
                <p id="conlluFileName"></p>
            </div>
            <div style="width:50px">
                <p id="currentTreeNumber" onClick="goToTreeToggle()"></p>
            </div>
            <div class="toolbar btn-nav" align="center">
                <input type="button" tabindex="-1" value="&#x21E4" onClick="firstTree()" />
                <input type="button" tabindex="-1" value="&#x2190" onClick="prevTree()" />
                <input type="button" tabindex="-1" value="&#x2192" onClick="nextTree()" />
                <input type="button" tabindex="-1" value="&#x21E5" onClick="lastTree()" />
            </div>

            <div class="toolbar btn-options" align="right">
                <input type="button" tabindex="-1" value="+ Tree" onClick="addNewTree()" />
                <input type="button" tabindex="-1" value="- Tree" onClick="deleteCurrentTree()" />
                <input type="button" tabindex="-1" id="editbtn" value="edit" onClick="editToggle()" />
                <input type="button" tabindex="-1" value="download" onClick="downloadToggle()" />
                <input type="button" tabindex="-1" value="save" id="save_remote" onClick="saveTreeRemote()" />
                <input type="button" tabindex="-1" value="rename" id="rename_toggle" onClick="renameToggle()" />
                <input type="button" tabindex="-1" value="Authenticate with Google Drive" id="auth_btn"
                    onClick="authenticate()" />
                <input type="button" tabindex="-1" value="Logout" id="logout_btn" onClick="logout()" />
                <input type="button" tabindex="-1" value="direction" onClick="directionToggle()" />
                <input type="button" tabindex="-1" value="tags" onClick="tagsToggle()" />
                <input type="button" tabindex="-1" value="listing" onClick="search(treesArray)" id="listingBtn" />
            </div>
        </div>

        <div class="container" style="width:100%">
            <section id="upload3" class="upload">
                <p>Optional Config File:</p>
                <select id="config_file_selector">
                    <option>Choose File</option>
                    <option>Upload your config file</option>
                </select>
                <input style="float:left; display:none" type="file" name="configFile" id="configFile" />
            </section>
        </div>

        <div class="container" style="width:100%">
            <section id="upload" class="upload">
                <p>Select CoNLL-U File:</p>
                <input style="float:left" type="file" id="inputFile" name="treefiles[]" /><br>
                <input style="float:right" type="button" id="treebtn" value="Upload"
                    onClick="setupTreePage(LocalFileInputChecker)" />
                <!-- <input style="float:right" type="button" id="treebtn" value="Upload" onClick="setJSONtreeData()" /> -->
            </section>
        </div>

        <div class="container" style="width:100%">
            <section id="upload1" class="upload">
                <p>MyDrive CoNLL-U files</p>
                <input style="float: left; display: none" type="button" id="browse_btn" value="Browse MyDrive" />
                <p id="picked_filename" style="float: left"></p>
                <input style="float:right" type="button" id="treebtn" value="Upload"
                    onClick="setupTreePage(RemoteFileInputChecker)" />
            </section>
        </div>

        <div class="container" style="width:100%">
            <section id="upload2" class="upload">
                <form id="upload2">
                    <p>Or Enter Text:</i></p><br>
                    <textarea id="treedata2" rows="5"
                        placeholder="Each line of text will become a seperate tree."></textarea>
                </form>
                <input style="float:right" type="button" id="treebtn2" value="Upload" onClick="setSentenceTreeData()" />
            </section>
        </div>

        <section id="download">
            <form id="download">
                <p>File Name</p>
                <input type="text" id="filename" />
            </form>
            <input type="button" id="dwnbtn" value="Download" onClick="downloadTree()" />
            <button onClick="hideAllWindows()">Close</button>
        </section>

        <section id="rename">
            <form id="rename">
                <p>File Name</p>
                <input type="text" id="filename_remote" />
            </form>
            <input type="button" id="rename_btn" value="Save" onClick="saveTreeRemote();hideAllWindows()" />
            <button onClick="hideAllWindows()">Close</button>
        </section>

        <section id="gototree">
            <form id="gototree">
                <p>Please select tree number:</p>
                <input type="number" id="treeNumberInput" min="1" max="1" style="width: 3em"
                    onkeypress="return goToKeyPress(event);">
            </form><br>
            <input type="button" id="goTreebtn" value="Go" onClick="goToTree()" />
            <button onClick="hideAllWindows()">Close</button>
        </section>

        <section id='labels'>
            <label class='labelsp'>Relation Labels</label>

        </section>

        <section id='postags'>
            <label class='labelsp'>POS Tags</label>

        </section>

        <div id="listing" class="scroll" style="width:50%;height:400px;">
            <section id="search" style="display:block; width: 90%;" />
        </div>


        <section id='morphology'>
            <p class='labelsp'>Token:</p>
            <div>
                <input type="text" id="morphologyName"><br>
            </div>

            <div id='lemmaField'>
            </div>

            <div id='lexicalFeats'>
            </div>

            <p class='labelsp' id='labelspMorphoFeats'>Morphological Features:</p>
            <div id='morphoFeats'>
            </div>
            <p>
                <button onClick="saveMorphology()">OK</button>
                <button onClick="cancelMorphology()">Cancel</button>
            </p>
        </section>

    </div>

    <div id="sents" class="standard">
        <p id="fullSentence"></p>
        <p id="print"></p>
        <hr>
    </div>


    <script src="scripts/jquery-1.11.3.min.js"></script>
    <script src="scripts/d3.v3.min.js"></script>
    <script src="scripts/blob.js"></script>
    <script src="scripts/FileSaver.min.js"></script>
    <script src="scripts/saveSvgAsPng.js"></script>
    <script src="scripts/underscore-min.js"></script>
    <script src="scripts/cycle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        // set this to the right server origin when pushed to Github
        const SERVER_ORIGIN = 'http://localhost:3000';

        let tokenClient;
        let gapiClientInited = false;
        let gapiPickerInited = false;
        let gisInited = false;
        let isAuthenticated = false;
        let fileId;
        let pickedFile;
        var defaultConfigFiles = [];

        function populateConfigFileSelectorHelper(files) {
            let option;
            let selectList = document.getElementById("config_file_selector");
            let lastOption = selectList.lastElementChild;
            // pop last child element of selectList
            selectList.removeChild(lastOption);
            for (let file of files) {
                option = document.createElement("option");
                option.text = file.name;
                selectList.appendChild(option);
            };
            selectList.appendChild(lastOption);
            // set the default value to the first option
            selectList.selectedIndex = 0;
        }

        function retrieveConfigFiles() {
            return new Promise((resolve, reject) => {
                let fileObjects = [];
                let rsp;
                axios.get('https://api.github.com/repos/CAMeL-Lab/palmyra/contents/palmyraSampleFiles/config').then(async rsp => {
                    let files = rsp.data;
                    for (let file of files) {
                        rsp = await axios.get(file.download_url);
                        let fileObject = new File([rsp], file.name, { type: "text/plain" });
                        fileObjects.push(fileObject);
                    }
                    resolve(fileObjects);
                }).catch(err => {
                    reject(err);
                });
            })
        }

        function populateConfigFileSelector() {
            let selectList = document.getElementById("config_file_selector");
            selectList.onchange = () => {
                if (selectList.selectedIndex == selectList.options.length - 1) document.getElementById("configFile").style.display = "block";
                else document.getElementById("configFile").style.display = "none"
            }
            retrieveConfigFiles().then(files => {
                defaultConfigFiles = files;
                populateConfigFileSelectorHelper(files);
            }).catch(err => {
                console.log(err);
            });
        }

        /**
         * Callback after api script is loaded.
         */
        function gapiLoaded(libraryName, callback) {
            gapi.load(libraryName, callback);
        }

        function initializeGapiPicker() {
            gapiPickerInited = true;
        }

        /**
         * Callback after the API client is loaded.
         */
        function initializeGapiClient() {
            axios.get(`${SERVER_ORIGIN}/gapi_credentials`).then(rsp => {
                let credentials = rsp.data;
                gapi.client.init({
                    apiKey: credentials.apiKey,
                    discoveryDocs: credentials.discoveryDocs,
                }).then(() => {
                    gapiClientInited = true;
                    maybeEnableAuthButton();
                }).catch(err => {
                    console.log(err);
                })
            }).catch(err => {
                console.log(err);
            })
        }

        /**
         * Callback after Google Identity Services are loaded.
         */
        function gisLoaded() {
            axios.get(`${SERVER_ORIGIN}/gis_credentials`).then(rsp => {
                let credentials = rsp.data;
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: credentials.client_id,
                    scope: credentials.scope,
                    callback: '', // defined later
                });
                gisInited = true;
                maybeEnableAuthButton();
            }).catch(err => {
                console.log(err);
            })
        }

        function logout() {
            // remove access token from session storage
            sessionStorage.removeItem('GCP_access_token');
            // remove access token from gapi client
            gapi.client.setToken(null);
            // disable browse button
            $("#browse_btn").hide();
            // if logged out successfully, hide logout button && show authentication button
            $(".toolbar [id='logout_btn']").hide();
            $(".toolbar [id='auth_btn']").show();
        }

        function onAuthenticated() {
            // set access token in gapi client for future requests
            gapi.client.setToken({ access_token: getTokenFromSessionStorage() });
            isAuthenticated = true;
            // alert("Authenticated with Google Drive successfully!");
            // enable browse button
            enableBrowseButton();
            // if authenticated successfully, hide authentication button && show logout button
            $(".toolbar [id='auth_btn']").hide();
            $(".toolbar [id='logout_btn']").show();
        }

        function authenticate() {
            // callbackafter access token is retrieved
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                setTokenInSessionStorage(gapi.client.getToken().access_token);
                onAuthenticated();
            };
            // need to add a check for when the token expires
            if (gapi.client.getToken() === null) {
                // Prompt the user to select a Google Account and ask for consent to share their data
                // when establishing a new session.
                tokenClient.requestAccessToken({ prompt: 'consent' });
            }
        }

        function setTokenInSessionStorage(token) {
            sessionStorage.setItem('GCP_access_token', token);
        }

        function getTokenFromSessionStorage() {
            return sessionStorage.getItem('GCP_access_token');
        }

        function enableBrowseButton() {
            let browseBtn = document.getElementById("browse_btn");
            browseBtn.style.display = "inline-block";
            browseBtn.onclick = () => {
                showPicker(gapi.client.getToken().access_token, pickerCallback);
            };
        }

        function showPicker(accessToken, callback) {
            axios.get(`${SERVER_ORIGIN}/gapi_credentials`).then(rsp => {
                let credentials = rsp.data;
                let view = new google.picker.DocsView(google.picker.ViewId.DOCS);
                view.setMimeTypes('text/plain');
                view.setMode(google.picker.DocsViewMode.LIST);
                let picker = new google.picker.PickerBuilder()
                    .addView(view)
                    .setOAuthToken(accessToken)
                    .setDeveloperKey(credentials.apiKey)
                    .setCallback(callback)
                    .build();
                picker.setVisible(true);
            }).catch(err => {
                console.log(err);
            })
        }

        function pickerCallback(data) {
            // if the user picked a file
            // need to check if the file is a conllu file
            if (data[google.picker.Response.ACTION] == google.picker.Action.PICKED) {
                let doc = data[google.picker.Response.DOCUMENTS][0];
                let fileNameParts = doc.name.split('.');
                if (fileNameParts[fileNameParts.length - 1] !== 'conllu' && fileNameParts[fileNameParts.length - 1] !== 'conllx') {
                    alert(
                        "File does not end with the .conllu/conllx extension, please upload a ConllU/X file."
                    );
                    return;
                }
                // need to add extension for conllx files as well
                let url = 'https://www.googleapis.com/drive/v3/files/' + doc.id + '?alt=media';
                axios.get(url, {
                    headers: {
                        'Authorization': 'Bearer ' + gapi.client.getToken().access_token
                    }
                }).then(rsp => {
                    // show name of picked file
                    // set global pickedFile variable
                    document.getElementById("picked_filename").innerHTML = doc.name;
                    pickedFile = new File([rsp], doc.name, { type: doc.mimeType });
                    fileId = doc.id;
                }).catch(err => {
                    console.log(err);
                    alert("Failed to retrieve file!");
                });
            }
        }

        /**
         * Enables user interaction after all libraries are loaded.
         */
        function maybeEnableAuthButton() {
            if (gapiClientInited && gapiPickerInited && gisInited && !isAuthenticated) {
                $(".toolbar [id='auth_btn']").show();
            }
        }

        function maybeEnableSaveRemoteButton() {
            if (gapiClientInited && gisInited) {
                $("#save_remote").show();
            }
        }

        // retrieve access token from session storage when page is loaded
        window.onload = function () {
            if (getTokenFromSessionStorage()) {
                onAuthenticated();
            }
        };

    </script>

    <script async defer src="https://apis.google.com/js/api.js"
        onload="gapiLoaded('client', initializeGapiClient)"></script>
    <script async defer src="https://apis.google.com/js/api.js"
        onload="gapiLoaded('picker', initializeGapiPicker)"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <script src="main.js"></script>

    <script>
        function goToKeyPress(e) {
            // look for window.event in case event isn't passed in
            e = e || window.event;
            if (e.keyCode == 13) {
                document.getElementById('goTreebtn').click();
                return false;
            }
            return true;
        }
    </script>

</body>

</html>